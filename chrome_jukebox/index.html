<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Chrome Bell: Receiver</title>

	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
	<link rel="stylesheet" href="styles.css">
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>		
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>	
    <script src="//www.gstatic.com/cast/sdk/libs/receiver/2.0.0/cast_receiver.js"></script>
    <script src="underscore-min.js"></script>    
  </head>
  <body>  
  
  <div class="header-wrapper">
	  <div class="container header-container">
	    <div class="col-md-9">
	        <h1 class="title">An awesome party!</h1>
	        <h2 class="sub-title"> "Ain't no time like party time"</h2>
	    </div>
	    <div class="col-md-3 text-right">
	       <h3 class="textnum">Text to: <span>617-349-2939</span></h3>	        
	    </div>
	  </div>
  </div>
  
  <div class="body-container container">
    <div class="col-md-4 guest-list-container">
      <h3 class="header">Playlist</h3>
      <div id="playlist"></div>
    </div>
    <div class="col-md-8">
        <div id="playerContainer" class="text-center">
            <h3>It looks like nothing is queued.</h3>
        </div>
    </div>
  </div>    

<script type="text/template" id="playlistTemplate">
<ul class="list list-unstyled">

<% _.forEach(videos, function(el){ %>
  <li class='<%= el.played ? 'played': '' %>'>
    <span class="from"><%= el.from %>:</span> <%= el.keyword %> <span class="time"><%= el.at %></span></li>
<% }); %>

</ul>

</script>
  
<script>
var eventId = "1";

var queuedVideos = [];
var currentIndex = 0;

var player = null;  
var playlistTemplate = _.template( $("#playlistTemplate").html() );

function updatePlaylist(){
    var reversedArray = Array.concat( queuedVideos );
    reversedArray.reverse();
    
    $("#playlist").html( playlistTemplate({videos: reversedArray}) );
}

function playNextVideo(){
    
    queuedVideos[currentIndex].played = true;
    
    if( currentIndex < queuedVideos.length - 1 ){
        currentIndex += 1;
        
        if( queuedVideos[currentIndex].videoId ){
            player.loadVideoById( queuedVideos[currentIndex].videoId );
        }else{
            currentIndex += 1;
        }
    }
    
    updatePlaylist();
}

function addToQueue( searchObj ){
    
    var d = new Date();
    var h, m, a;        
        
    if( d.getHours() > 12 ){
        h = d.getHours() - 12;
        a = "pm";
    }else{
        h = d.getHours();
        a = "am";        
    }
    
    if( d.getMinutes() < 10 ){
        m = "0" + d.getMinutes();
    }else{
        m = d.getMinutes();
    }
    
    searchObj.at = h + ":" + m + a;
    searchObj.played = false;

    queuedVideos.push( searchObj );
    updatePlaylist();
    
    if(player == null){
        var height = $("body").height() - $(".header-wrapper").height() - 60;
	    
        currentIndex = 0;
	    player = new YT.Player('playerContainer', {
	        height: height,
	        width: '100%',
	        videoId: queuedVideos[currentIndex].videoId,
	        playerVars: {'autoplay': 1, 'controls': 0},
	        events: {'onStateChange': onPlayerStateChange}
        });
	    
    }
    
}

function queueSearch( searchObj ){    
    var request = gapi.client.youtube.search.list({q: searchObj.keyword, videoEmbeddable: true, part: 'snippet', type: 'video'});
        
    request.execute(function(response) {
        searchObj.videoId = null;
        if( response.result.items.length ){
            searchObj.videoId = response.result.items[0].id.videoId;
        }
        
        addToQueue( searchObj );
    });    
}

function init(){
    gapi.client.setApiKey("AIzaSyBpDjO4BtsuNJNou_ICN6UUMi5r2G6Nthw");
    gapi.client.load('youtube', 'v3', function(){ 
        queueSearch( {from: "201-952-9906", keyword: "sexy bitch video"});        
    });
}
  
function onYouTubeIframeAPIReady(){
    
}

function onPlayerStateChange(event){
    if( event.data == YT.PlayerState.ENDED ){
        playNextVideo();
    }
}

$(document).ready(function(){
    
});

</script>   
  
  <script src="https://apis.google.com/js/client.js?onload=init"></script>
  <script src="https://www.youtube.com/iframe_api"></script>   
  </body>
</html>